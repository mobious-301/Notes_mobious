以下是玛莲妮亚（Malenia）**完整两阶段行为树**的整合设计，采用标准行为树语法并标注阶段差异，包含所有核心机制和阶段转换逻辑：

---

### **玛莲妮亚完全行为树（Unreal Behavior Tree格式）**
```python
Root (Selector)
│
├── [死亡检测] (Sequence)
│    ├── Health <= 0?
│    └── PlayDeathAnimation()
│
├── [阶段转换] (Sequence) 
│    ├── CurrentPhase != Phase2 AND Health <= 50%?
│    ├── LockAllActions()  # 强制中断当前行为
│    ├── PlayPhaseTransition()  # 猩红绽放动画
│    ├── ActivateScarletAura()  # 开启腐败领域
│    └── UpgradeAttackPatterns()  # 加载二阶段招式
│
├── [受击反应] (Priority Selector)
│    ├── [被击退] (Sequence): IsHitByHeavyAttack? → PlayStaggerAnimation()
│    └── [普通受击] (Sequence): IsHit? → PlayHitReaction() + CounterAttackRoll()
│
├── [战斗行为] (Dynamic Selector)  # 动态优先级
│    │
│    ├── [二阶段专属] (Parallel): 
│    │   ├── [腐败领域] (Sequence): Every20s → ScarletExplosion()
│    │   └── [空中作战] (Selector): 
│    │       ├── [俯冲攻击] (Sequence): PlayerDistance > 10m → AerialDive()
│    │       └── [低空横扫] (Sequence): PlayerDistance 5-8m → LowSweep()
│    │
│    ├── [水鸟乱舞] (Sequence): 
│    │   ├── CooldownFinished? 
│    │   ├── PlayerDistance 4-15m?
│    │   └── If(Phase2) → EnhancedWaterfowlDance()  # 二阶段强化版
│    │       Else → BaseWaterfowlDance()
│    │
│    ├── [连招系统] (Probability Selector): 
│    │   ├── [3+1斩] (Weight=30%): Phase1 → Combo_3hit()
│    │   ├── [5连斩] (Weight=40%): Phase2 → Combo_5hit()  # 二阶段扩展
│    │   └── [神经刀] (Weight=15%): RandomInstantSlash()
│    │
│    └── [机动策略] (Selector):
│        ├── [防御反击] (Sequence): 
│        │   ├── PredictPlayerAttack() 
│        │   └── If(Phase2) → ParryAndHeal()  # 二阶段格挡回血
│        │       Else → BaseParry()
│        └── [距离控制] (Parallel): 
│            ├── AdjustDistance(Phase1? 3m : 5m)  # 二阶段更激进
│            └── EnvironmentAwareMovement()
│
└── [闲置行为] (Random Selector)
     ├── [警戒移动] (Sequence): PatrolAroundArena()
     └── [挑衅动作] (Sequence): PlayTauntAnimation()
```

---

### **关键机制说明表**

| 机制                | 第一阶段                          | 第二阶段变化                          |
|---------------------|-----------------------------------|---------------------------------------|
| **水鸟乱舞**        | 地面三连击                        | 追加腐败冲击波，冷却-30%              |
| **吸血效果**        | 恢复造成伤害的20%                 | 恢复量提升至30%，格挡反击额外回血     |
| **招式派生**        | 最多3连击                         | 可派生至5连击，新增跳跃取消           |
| **移动模式**        | 保持3-8米距离                     | 主动贴近至2-5米，空中机动性+50%       |
| **读指令响应**      | 基础攻击预测                      | 增加治疗/法术预判，反应速度+25%       |
| **环境交互**        | 无                                | 地面持续腐败伤害，每20秒范围爆炸      |

---

### **阶段转换流程图**
```mermaid
graph TD
    A[战斗开始] --> B{血量≤50%?}
    B -- 否 --> C[执行第一阶段行为树]
    B -- 是 --> D[播放猩红绽放动画]
    D --> E[激活以下效果]:
    E --> E1[腐败领域持续伤害]
    E --> E2[解锁空中攻击节点]
    E --> E3[所有连招段数+2]
    E --> E4[水鸟乱舞升级]
    E --> F[执行第二阶段行为树]
```

---

### **行为树特性总结**
1. **动态优先级调整**：
   - 二阶段时`[空中作战]`节点优先级提升
   - 血量低于30%时`[防御反击]`权重增加

2. **条件覆盖全面**：
   - 距离检测细分5个区间（贴身/近/中/远/超远）
   - 冷却时间系统防止技能滥用

3. **反玩家策略设计**：
   ```python
   # 伪代码：针对玩家行为的动态反制
   if player.spamming_roll:
       use_delayed_attack()  # 延迟出招抓翻滚
   elif player.healing:
       if phase2: teleport_backstab()  # 二阶段瞬移惩罚
   ```

4. **难度梯度控制**：
   - 一阶段作为"教学模式"展示基础招式
   - 二阶段通过**复合机制**（空中+地面+环境伤害）制造压力

此行为树完整还原了玛莲妮亚的战斗逻辑，其精妙之处在于：
- **阶段差异**不是简单数值加强，而是**战斗维度扩展**（新增垂直空间利用）
- 通过**吸血机制**与**腐败领域**的协同设计，强制玩家改变战术
- 保留一阶段部分招式但调整派生路线，既保持熟悉感又制造认知颠覆